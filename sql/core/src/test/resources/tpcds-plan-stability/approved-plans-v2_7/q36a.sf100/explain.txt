== Physical Plan ==
TakeOrderedAndProject (63)
+- * Project (62)
   +- Window (61)
      +- * Sort (60)
         +- Exchange (59)
            +- * HashAggregate (58)
               +- Exchange (57)
                  +- * HashAggregate (56)
                     +- Union (55)
                        :- * HashAggregate (25)
                        :  +- Exchange (24)
                        :     +- * HashAggregate (23)
                        :        +- * Project (22)
                        :           +- * BroadcastHashJoin Inner BuildRight (21)
                        :              :- * Project (15)
                        :              :  +- * Project (14)
                        :              :     +- * HashAggregate (13)
                        :              :        +- * Project (12)
                        :              :           +- * BroadcastHashJoin Inner BuildRight (11)
                        :              :              :- * Project (6)
                        :              :              :  +- * BroadcastHashJoin Inner BuildRight (5)
                        :              :              :     :- * Filter (3)
                        :              :              :     :  +- * ColumnarToRow (2)
                        :              :              :     :     +- Scan parquet default.store_sales (1)
                        :              :              :     +- ReusedExchange (4)
                        :              :              +- BroadcastExchange (10)
                        :              :                 +- * Filter (9)
                        :              :                    +- * ColumnarToRow (8)
                        :              :                       +- Scan parquet default.item (7)
                        :              +- BroadcastExchange (20)
                        :                 +- * HashAggregate (19)
                        :                    +- * Filter (18)
                        :                       +- * ColumnarToRow (17)
                        :                          +- Scan parquet default.store (16)
                        :- * HashAggregate (49)
                        :  +- Exchange (48)
                        :     +- * HashAggregate (47)
                        :        +- * HashAggregate (46)
                        :           +- Exchange (45)
                        :              +- * HashAggregate (44)
                        :                 +- * Project (43)
                        :                    +- * BroadcastHashJoin Inner BuildRight (42)
                        :                       :- * Project (40)
                        :                       :  +- * HashAggregate (39)
                        :                       :     +- * SortMergeJoin Inner (38)
                        :                       :        :- * Sort (32)
                        :                       :        :  +- Exchange (31)
                        :                       :        :     +- * BroadcastHashJoin Inner BuildRight (30)
                        :                       :        :        :- * Filter (28)
                        :                       :        :        :  +- * ColumnarToRow (27)
                        :                       :        :        :     +- Scan parquet default.store_sales (26)
                        :                       :        :        +- ReusedExchange (29)
                        :                       :        +- * Sort (37)
                        :                       :           +- Exchange (36)
                        :                       :              +- * Filter (35)
                        :                       :                 +- * ColumnarToRow (34)
                        :                       :                    +- Scan parquet default.item (33)
                        :                       +- ReusedExchange (41)
                        +- * HashAggregate (54)
                           +- Exchange (53)
                              +- * HashAggregate (52)
                                 +- * HashAggregate (51)
                                    +- ReusedExchange (50)


(1) Scan parquet default.store_sales
Output [5]: [ss_item_sk#1, ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4, ss_sold_date_sk#5]
Batched: true
Location: InMemoryFileIndex []
PartitionFilters: [isnotnull(ss_sold_date_sk#5), dynamicpruningexpression(ss_sold_date_sk#5 IN dynamicpruning#6)]
PushedFilters: [IsNotNull(ss_item_sk), IsNotNull(ss_store_sk)]
ReadSchema: struct<ss_item_sk:int,ss_store_sk:int,ss_ext_sales_price:decimal(7,2),ss_net_profit:decimal(7,2)>

(2) ColumnarToRow [codegen id : 4]
Input [5]: [ss_item_sk#1, ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4, ss_sold_date_sk#5]

(3) Filter [codegen id : 4]
Input [5]: [ss_item_sk#1, ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4, ss_sold_date_sk#5]
Condition : (isnotnull(ss_item_sk#1) AND isnotnull(ss_store_sk#2))

(4) ReusedExchange [Reuses operator id: 68]
Output [1]: [d_date_sk#7]

(5) BroadcastHashJoin [codegen id : 4]
Left keys [1]: [ss_sold_date_sk#5]
Right keys [1]: [d_date_sk#7]
Join condition: None

(6) Project [codegen id : 4]
Output [4]: [ss_item_sk#1, ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4]
Input [6]: [ss_item_sk#1, ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4, ss_sold_date_sk#5, d_date_sk#7]

(7) Scan parquet default.item
Output [3]: [i_item_sk#8, i_class#9, i_category#10]
Batched: true
Location [not included in comparison]/{warehouse_dir}/item]
PushedFilters: [IsNotNull(i_item_sk)]
ReadSchema: struct<i_item_sk:int,i_class:string,i_category:string>

(8) ColumnarToRow [codegen id : 2]
Input [3]: [i_item_sk#8, i_class#9, i_category#10]

(9) Filter [codegen id : 2]
Input [3]: [i_item_sk#8, i_class#9, i_category#10]
Condition : isnotnull(i_item_sk#8)

(10) BroadcastExchange
Input [3]: [i_item_sk#8, i_class#9, i_category#10]
Arguments: HashedRelationBroadcastMode(List(cast(input[0, int, false] as bigint)),false), [id=#11]

(11) BroadcastHashJoin [codegen id : 4]
Left keys [1]: [ss_item_sk#1]
Right keys [1]: [i_item_sk#8]
Join condition: None

(12) Project [codegen id : 4]
Output [5]: [ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4, i_class#9, i_category#10]
Input [7]: [ss_item_sk#1, ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4, i_item_sk#8, i_class#9, i_category#10]

(13) HashAggregate [codegen id : 4]
Input [5]: [ss_store_sk#2, ss_ext_sales_price#3, ss_net_profit#4, i_class#9, i_category#10]
Keys [3]: [ss_store_sk#2, i_category#10, i_class#9]
Functions [2]: [partial_sum(UnscaledValue(ss_net_profit#4)), partial_sum(UnscaledValue(ss_ext_sales_price#3))]
Aggregate Attributes [2]: [sum#12, sum#13]
Results [5]: [ss_store_sk#2, i_category#10, i_class#9, sum#14, sum#15]

(14) Project [codegen id : 4]
Output [5]: [ss_store_sk#2, i_category#10, i_class#9, sum#14 AS _pushedexpression#16, sum#15 AS _pushedexpression#17]
Input [5]: [ss_store_sk#2, i_category#10, i_class#9, sum#14, sum#15]

(15) Project [codegen id : 4]
Output [3]: [ss_store_sk#2, i_category#10, i_class#9]
Input [5]: [ss_store_sk#2, i_category#10, i_class#9, _pushedexpression#16, _pushedexpression#17]

(16) Scan parquet default.store
Output [29]: [s_store_sk#18, s_store_id#19, s_rec_start_date#20, s_rec_end_date#21, s_closed_date_sk#22, s_store_name#23, s_number_employees#24, s_floor_space#25, s_hours#26, s_manager#27, s_market_id#28, s_geography_class#29, s_market_desc#30, s_market_manager#31, s_division_id#32, s_division_name#33, s_company_id#34, s_company_name#35, s_street_number#36, s_street_name#37, s_street_type#38, s_suite_number#39, s_city#40, s_county#41, s_state#42, s_zip#43, s_country#44, s_gmt_offset#45, s_tax_percentage#46]
Batched: true
Location [not included in comparison]/{warehouse_dir}/store]
PushedFilters: [IsNotNull(s_state), EqualTo(s_state,TN), IsNotNull(s_store_sk)]
ReadSchema: struct<s_store_sk:int,s_store_id:string,s_rec_start_date:date,s_rec_end_date:date,s_closed_date_sk:int,s_store_name:string,s_number_employees:int,s_floor_space:int,s_hours:string,s_manager:string,s_market_id:int,s_geography_class:string,s_market_desc:string,s_market_manager:string,s_division_id:int,s_division_name:string,s_company_id:int,s_company_name:string,s_street_number:string,s_street_name:string,s_street_type:string,s_suite_number:string,s_city:string,s_county:string,s_state:string,s_zip:string,s_country:string,s_gmt_offset:decimal(5,2),s_tax_percentage:decimal(5,2)>

(17) ColumnarToRow [codegen id : 3]
Input [29]: [s_store_sk#18, s_store_id#19, s_rec_start_date#20, s_rec_end_date#21, s_closed_date_sk#22, s_store_name#23, s_number_employees#24, s_floor_space#25, s_hours#26, s_manager#27, s_market_id#28, s_geography_class#29, s_market_desc#30, s_market_manager#31, s_division_id#32, s_division_name#33, s_company_id#34, s_company_name#35, s_street_number#36, s_street_name#37, s_street_type#38, s_suite_number#39, s_city#40, s_county#41, s_state#42, s_zip#43, s_country#44, s_gmt_offset#45, s_tax_percentage#46]

(18) Filter [codegen id : 3]
Input [29]: [s_store_sk#18, s_store_id#19, s_rec_start_date#20, s_rec_end_date#21, s_closed_date_sk#22, s_store_name#23, s_number_employees#24, s_floor_space#25, s_hours#26, s_manager#27, s_market_id#28, s_geography_class#29, s_market_desc#30, s_market_manager#31, s_division_id#32, s_division_name#33, s_company_id#34, s_company_name#35, s_street_number#36, s_street_name#37, s_street_type#38, s_suite_number#39, s_city#40, s_county#41, s_state#42, s_zip#43, s_country#44, s_gmt_offset#45, s_tax_percentage#46]
Condition : ((isnotnull(s_state#42) AND (s_state#42 = TN)) AND isnotnull(s_store_sk#18))

(19) HashAggregate [codegen id : 3]
Input [29]: [s_store_sk#18, s_store_id#19, s_rec_start_date#20, s_rec_end_date#21, s_closed_date_sk#22, s_store_name#23, s_number_employees#24, s_floor_space#25, s_hours#26, s_manager#27, s_market_id#28, s_geography_class#29, s_market_desc#30, s_market_manager#31, s_division_id#32, s_division_name#33, s_company_id#34, s_company_name#35, s_street_number#36, s_street_name#37, s_street_type#38, s_suite_number#39, s_city#40, s_county#41, s_state#42, s_zip#43, s_country#44, s_gmt_offset#45, s_tax_percentage#46]
Keys [1]: [s_store_sk#18]
Functions: []
Aggregate Attributes: []
Results [1]: [s_store_sk#18]

(20) BroadcastExchange
Input [1]: [s_store_sk#18]
Arguments: HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#47]

(21) BroadcastHashJoin [codegen id : 4]
Left keys [1]: [ss_store_sk#2]
Right keys [1]: [s_store_sk#18]
Join condition: None

(22) Project [codegen id : 4]
Output [2]: [i_category#10, i_class#9]
Input [4]: [ss_store_sk#2, i_category#10, i_class#9, s_store_sk#18]

(23) HashAggregate [codegen id : 4]
Input [2]: [i_category#10, i_class#9]
Keys [2]: [i_category#10, i_class#9]
Functions [2]: [partial_sum(UnscaledValue(ss_net_profit#4)), partial_sum(UnscaledValue(ss_ext_sales_price#3))]
Aggregate Attributes [2]: [sum#48, sum#49]
Results [4]: [i_category#10, i_class#9, sum#50, sum#51]

(24) Exchange
Input [4]: [i_category#10, i_class#9, sum#50, sum#51]
Arguments: hashpartitioning(i_category#10, i_class#9, 5), ENSURE_REQUIREMENTS, [id=#52]

(25) HashAggregate [codegen id : 5]
Input [4]: [i_category#10, i_class#9, sum#50, sum#51]
Keys [2]: [i_category#10, i_class#9]
Functions [2]: [sum(UnscaledValue(ss_net_profit#4)), sum(UnscaledValue(ss_ext_sales_price#3))]
Aggregate Attributes [2]: [sum(UnscaledValue(ss_net_profit#4))#53, sum(UnscaledValue(ss_ext_sales_price#3))#54]
Results [6]: [cast(CheckOverflow((promote_precision(MakeDecimal(sum(UnscaledValue(ss_net_profit#4))#53,17,2)) / promote_precision(MakeDecimal(sum(UnscaledValue(ss_ext_sales_price#3))#54,17,2))), DecimalType(37,20)) as decimal(38,20)) AS gross_margin#55, i_category#10, i_class#9, 0 AS t_category#56, 0 AS t_class#57, 0 AS lochierarchy#58]

(26) Scan parquet default.store_sales
Output [23]: [ss_sold_time_sk#59, ss_item_sk#1, ss_customer_sk#60, ss_cdemo_sk#61, ss_hdemo_sk#62, ss_addr_sk#63, ss_store_sk#2, ss_promo_sk#64, ss_ticket_number#65, ss_quantity#66, ss_wholesale_cost#67, ss_list_price#68, ss_sales_price#69, ss_ext_discount_amt#70, ss_ext_sales_price#3, ss_ext_wholesale_cost#71, ss_ext_list_price#72, ss_ext_tax#73, ss_coupon_amt#74, ss_net_paid#75, ss_net_paid_inc_tax#76, ss_net_profit#4, ss_sold_date_sk#5]
Batched: true
Location: InMemoryFileIndex []
PartitionFilters: [isnotnull(ss_sold_date_sk#5), dynamicpruningexpression(ss_sold_date_sk#5 IN dynamicpruning#77)]
PushedFilters: [IsNotNull(ss_store_sk), IsNotNull(ss_item_sk)]
ReadSchema: struct<ss_sold_time_sk:int,ss_item_sk:int,ss_customer_sk:int,ss_cdemo_sk:int,ss_hdemo_sk:int,ss_addr_sk:int,ss_store_sk:int,ss_promo_sk:int,ss_ticket_number:int,ss_quantity:int,ss_wholesale_cost:decimal(7,2),ss_list_price:decimal(7,2),ss_sales_price:decimal(7,2),ss_ext_discount_amt:decimal(7,2),ss_ext_sales_price:decimal(7,2),ss_ext_wholesale_cost:decimal(7,2),ss_ext_list_price:decimal(7,2),ss_ext_tax:decimal(7,2),ss_coupon_amt:decimal(7,2),ss_net_paid:decimal(7,2),ss_net_paid_inc_tax:decimal(7,2),ss_net_profit:decimal(7,2)>

(27) ColumnarToRow [codegen id : 7]
Input [23]: [ss_sold_time_sk#59, ss_item_sk#1, ss_customer_sk#60, ss_cdemo_sk#61, ss_hdemo_sk#62, ss_addr_sk#63, ss_store_sk#2, ss_promo_sk#64, ss_ticket_number#65, ss_quantity#66, ss_wholesale_cost#67, ss_list_price#68, ss_sales_price#69, ss_ext_discount_amt#70, ss_ext_sales_price#3, ss_ext_wholesale_cost#71, ss_ext_list_price#72, ss_ext_tax#73, ss_coupon_amt#74, ss_net_paid#75, ss_net_paid_inc_tax#76, ss_net_profit#4, ss_sold_date_sk#5]

(28) Filter [codegen id : 7]
Input [23]: [ss_sold_time_sk#59, ss_item_sk#1, ss_customer_sk#60, ss_cdemo_sk#61, ss_hdemo_sk#62, ss_addr_sk#63, ss_store_sk#2, ss_promo_sk#64, ss_ticket_number#65, ss_quantity#66, ss_wholesale_cost#67, ss_list_price#68, ss_sales_price#69, ss_ext_discount_amt#70, ss_ext_sales_price#3, ss_ext_wholesale_cost#71, ss_ext_list_price#72, ss_ext_tax#73, ss_coupon_amt#74, ss_net_paid#75, ss_net_paid_inc_tax#76, ss_net_profit#4, ss_sold_date_sk#5]
Condition : (isnotnull(ss_store_sk#2) AND isnotnull(ss_item_sk#1))

(29) ReusedExchange [Reuses operator id: 72]
Output [28]: [d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104]

(30) BroadcastHashJoin [codegen id : 7]
Left keys [1]: [ss_sold_date_sk#5]
Right keys [1]: [d_date_sk#7]
Join condition: None

(31) Exchange
Input [51]: [ss_sold_time_sk#59, ss_item_sk#1, ss_customer_sk#60, ss_cdemo_sk#61, ss_hdemo_sk#62, ss_addr_sk#63, ss_store_sk#2, ss_promo_sk#64, ss_ticket_number#65, ss_quantity#66, ss_wholesale_cost#67, ss_list_price#68, ss_sales_price#69, ss_ext_discount_amt#70, ss_ext_sales_price#3, ss_ext_wholesale_cost#71, ss_ext_list_price#72, ss_ext_tax#73, ss_coupon_amt#74, ss_net_paid#75, ss_net_paid_inc_tax#76, ss_net_profit#4, ss_sold_date_sk#5, d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104]
Arguments: hashpartitioning(ss_item_sk#1, 5), ENSURE_REQUIREMENTS, [id=#105]

(32) Sort [codegen id : 8]
Input [51]: [ss_sold_time_sk#59, ss_item_sk#1, ss_customer_sk#60, ss_cdemo_sk#61, ss_hdemo_sk#62, ss_addr_sk#63, ss_store_sk#2, ss_promo_sk#64, ss_ticket_number#65, ss_quantity#66, ss_wholesale_cost#67, ss_list_price#68, ss_sales_price#69, ss_ext_discount_amt#70, ss_ext_sales_price#3, ss_ext_wholesale_cost#71, ss_ext_list_price#72, ss_ext_tax#73, ss_coupon_amt#74, ss_net_paid#75, ss_net_paid_inc_tax#76, ss_net_profit#4, ss_sold_date_sk#5, d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104]
Arguments: [ss_item_sk#1 ASC NULLS FIRST], false, 0

(33) Scan parquet default.item
Output [22]: [i_item_sk#8, i_item_id#106, i_rec_start_date#107, i_rec_end_date#108, i_item_desc#109, i_current_price#110, i_wholesale_cost#111, i_brand_id#112, i_brand#113, i_class_id#114, i_class#9, i_category_id#115, i_category#10, i_manufact_id#116, i_manufact#117, i_size#118, i_formulation#119, i_color#120, i_units#121, i_container#122, i_manager_id#123, i_product_name#124]
Batched: true
Location [not included in comparison]/{warehouse_dir}/item]
PushedFilters: [IsNotNull(i_item_sk)]
ReadSchema: struct<i_item_sk:int,i_item_id:string,i_rec_start_date:date,i_rec_end_date:date,i_item_desc:string,i_current_price:decimal(7,2),i_wholesale_cost:decimal(7,2),i_brand_id:int,i_brand:string,i_class_id:int,i_class:string,i_category_id:int,i_category:string,i_manufact_id:int,i_manufact:string,i_size:string,i_formulation:string,i_color:string,i_units:string,i_container:string,i_manager_id:int,i_product_name:string>

(34) ColumnarToRow [codegen id : 9]
Input [22]: [i_item_sk#8, i_item_id#106, i_rec_start_date#107, i_rec_end_date#108, i_item_desc#109, i_current_price#110, i_wholesale_cost#111, i_brand_id#112, i_brand#113, i_class_id#114, i_class#9, i_category_id#115, i_category#10, i_manufact_id#116, i_manufact#117, i_size#118, i_formulation#119, i_color#120, i_units#121, i_container#122, i_manager_id#123, i_product_name#124]

(35) Filter [codegen id : 9]
Input [22]: [i_item_sk#8, i_item_id#106, i_rec_start_date#107, i_rec_end_date#108, i_item_desc#109, i_current_price#110, i_wholesale_cost#111, i_brand_id#112, i_brand#113, i_class_id#114, i_class#9, i_category_id#115, i_category#10, i_manufact_id#116, i_manufact#117, i_size#118, i_formulation#119, i_color#120, i_units#121, i_container#122, i_manager_id#123, i_product_name#124]
Condition : isnotnull(i_item_sk#8)

(36) Exchange
Input [22]: [i_item_sk#8, i_item_id#106, i_rec_start_date#107, i_rec_end_date#108, i_item_desc#109, i_current_price#110, i_wholesale_cost#111, i_brand_id#112, i_brand#113, i_class_id#114, i_class#9, i_category_id#115, i_category#10, i_manufact_id#116, i_manufact#117, i_size#118, i_formulation#119, i_color#120, i_units#121, i_container#122, i_manager_id#123, i_product_name#124]
Arguments: hashpartitioning(i_item_sk#8, 5), ENSURE_REQUIREMENTS, [id=#125]

(37) Sort [codegen id : 10]
Input [22]: [i_item_sk#8, i_item_id#106, i_rec_start_date#107, i_rec_end_date#108, i_item_desc#109, i_current_price#110, i_wholesale_cost#111, i_brand_id#112, i_brand#113, i_class_id#114, i_class#9, i_category_id#115, i_category#10, i_manufact_id#116, i_manufact#117, i_size#118, i_formulation#119, i_color#120, i_units#121, i_container#122, i_manager_id#123, i_product_name#124]
Arguments: [i_item_sk#8 ASC NULLS FIRST], false, 0

(38) SortMergeJoin [codegen id : 12]
Left keys [1]: [ss_item_sk#1]
Right keys [1]: [i_item_sk#8]
Join condition: None

(39) HashAggregate [codegen id : 12]
Input [73]: [ss_sold_time_sk#59, ss_item_sk#1, ss_customer_sk#60, ss_cdemo_sk#61, ss_hdemo_sk#62, ss_addr_sk#63, ss_store_sk#2, ss_promo_sk#64, ss_ticket_number#65, ss_quantity#66, ss_wholesale_cost#67, ss_list_price#68, ss_sales_price#69, ss_ext_discount_amt#70, ss_ext_sales_price#3, ss_ext_wholesale_cost#71, ss_ext_list_price#72, ss_ext_tax#73, ss_coupon_amt#74, ss_net_paid#75, ss_net_paid_inc_tax#76, ss_net_profit#4, ss_sold_date_sk#5, d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104, i_item_sk#8, i_item_id#106, i_rec_start_date#107, i_rec_end_date#108, i_item_desc#109, i_current_price#110, i_wholesale_cost#111, i_brand_id#112, i_brand#113, i_class_id#114, i_class#9, i_category_id#115, i_category#10, i_manufact_id#116, i_manufact#117, i_size#118, i_formulation#119, i_color#120, i_units#121, i_container#122, i_manager_id#123, i_product_name#124]
Keys [3]: [ss_store_sk#2, i_category#10, i_class#9]
Functions [2]: [partial_sum(UnscaledValue(ss_net_profit#4)), partial_sum(UnscaledValue(ss_ext_sales_price#3))]
Aggregate Attributes [2]: [sum#126, sum#127]
Results [5]: [ss_store_sk#2, i_category#10, i_class#9, sum#128, sum#129]

(40) Project [codegen id : 12]
Output [5]: [ss_store_sk#2, i_category#10, i_class#9, sum#128 AS _pushedexpression#130, sum#129 AS _pushedexpression#131]
Input [5]: [ss_store_sk#2, i_category#10, i_class#9, sum#128, sum#129]

(41) ReusedExchange [Reuses operator id: 20]
Output [1]: [s_store_sk#18]

(42) BroadcastHashJoin [codegen id : 12]
Left keys [1]: [ss_store_sk#2]
Right keys [1]: [s_store_sk#18]
Join condition: None

(43) Project [codegen id : 12]
Output [4]: [i_category#10, i_class#9, _pushedexpression#132, _pushedexpression#133]
Input [6]: [ss_store_sk#2, i_category#10, i_class#9, _pushedexpression#130, _pushedexpression#131, s_store_sk#18]

(44) HashAggregate [codegen id : 12]
Input [4]: [i_category#10, i_class#9, _pushedexpression#132, _pushedexpression#133]
Keys [2]: [i_category#10, i_class#9]
Functions [2]: [partial_sum(_pushedexpression#132), partial_sum(_pushedexpression#133)]
Aggregate Attributes [4]: [sum#134, isEmpty#135, sum#136, isEmpty#137]
Results [6]: [i_category#10, i_class#9, sum#138, isEmpty#139, sum#140, isEmpty#141]

(45) Exchange
Input [6]: [i_category#10, i_class#9, sum#138, isEmpty#139, sum#140, isEmpty#141]
Arguments: hashpartitioning(i_category#10, i_class#9, 5), ENSURE_REQUIREMENTS, [id=#142]

(46) HashAggregate [codegen id : 13]
Input [6]: [i_category#10, i_class#9, sum#138, isEmpty#139, sum#140, isEmpty#141]
Keys [2]: [i_category#10, i_class#9]
Functions [2]: [sum(_pushedexpression#132), sum(_pushedexpression#133)]
Aggregate Attributes [2]: [sum(_pushedexpression#132)#143, sum(_pushedexpression#133)#144]
Results [3]: [cast(sum(_pushedexpression#132)#143 as decimal(17,2)) AS ss_net_profit#145, cast(sum(_pushedexpression#133)#144 as decimal(17,2)) AS ss_ext_sales_price#146, i_category#10]

(47) HashAggregate [codegen id : 13]
Input [3]: [ss_net_profit#145, ss_ext_sales_price#146, i_category#10]
Keys [1]: [i_category#10]
Functions [2]: [partial_sum(ss_net_profit#145), partial_sum(ss_ext_sales_price#146)]
Aggregate Attributes [4]: [sum#147, isEmpty#148, sum#149, isEmpty#150]
Results [5]: [i_category#10, sum#151, isEmpty#152, sum#153, isEmpty#154]

(48) Exchange
Input [5]: [i_category#10, sum#151, isEmpty#152, sum#153, isEmpty#154]
Arguments: hashpartitioning(i_category#10, 5), ENSURE_REQUIREMENTS, [id=#155]

(49) HashAggregate [codegen id : 14]
Input [5]: [i_category#10, sum#151, isEmpty#152, sum#153, isEmpty#154]
Keys [1]: [i_category#10]
Functions [2]: [sum(ss_net_profit#145), sum(ss_ext_sales_price#146)]
Aggregate Attributes [2]: [sum(ss_net_profit#145)#156, sum(ss_ext_sales_price#146)#157]
Results [6]: [cast(CheckOverflow((promote_precision(sum(ss_net_profit#145)#156) / promote_precision(sum(ss_ext_sales_price#146)#157)), DecimalType(38,11)) as decimal(38,20)) AS gross_margin#158, i_category#10, null AS i_class#159, 0 AS t_category#160, 1 AS t_class#161, 1 AS lochierarchy#162]

(50) ReusedExchange [Reuses operator id: 45]
Output [6]: [i_category#10, i_class#9, sum#163, isEmpty#164, sum#165, isEmpty#166]

(51) HashAggregate [codegen id : 22]
Input [6]: [i_category#10, i_class#9, sum#163, isEmpty#164, sum#165, isEmpty#166]
Keys [2]: [i_category#10, i_class#9]
Functions [2]: [sum(_pushedexpression#167), sum(_pushedexpression#168)]
Aggregate Attributes [2]: [sum(_pushedexpression#167)#143, sum(_pushedexpression#168)#144]
Results [2]: [cast(sum(_pushedexpression#167)#143 as decimal(17,2)) AS ss_net_profit#145, cast(sum(_pushedexpression#168)#144 as decimal(17,2)) AS ss_ext_sales_price#146]

(52) HashAggregate [codegen id : 22]
Input [2]: [ss_net_profit#145, ss_ext_sales_price#146]
Keys: []
Functions [2]: [partial_sum(ss_net_profit#145), partial_sum(ss_ext_sales_price#146)]
Aggregate Attributes [4]: [sum#169, isEmpty#170, sum#171, isEmpty#172]
Results [4]: [sum#173, isEmpty#174, sum#175, isEmpty#176]

(53) Exchange
Input [4]: [sum#173, isEmpty#174, sum#175, isEmpty#176]
Arguments: SinglePartition, ENSURE_REQUIREMENTS, [id=#177]

(54) HashAggregate [codegen id : 23]
Input [4]: [sum#173, isEmpty#174, sum#175, isEmpty#176]
Keys: []
Functions [2]: [sum(ss_net_profit#145), sum(ss_ext_sales_price#146)]
Aggregate Attributes [2]: [sum(ss_net_profit#145)#178, sum(ss_ext_sales_price#146)#179]
Results [6]: [cast(CheckOverflow((promote_precision(sum(ss_net_profit#145)#178) / promote_precision(sum(ss_ext_sales_price#146)#179)), DecimalType(38,11)) as decimal(38,20)) AS gross_margin#180, null AS i_category#181, null AS i_class#182, 1 AS t_category#183, 1 AS t_class#184, 2 AS lochierarchy#185]

(55) Union

(56) HashAggregate [codegen id : 24]
Input [6]: [gross_margin#55, i_category#10, i_class#9, t_category#56, t_class#57, lochierarchy#58]
Keys [6]: [gross_margin#55, i_category#10, i_class#9, t_category#56, t_class#57, lochierarchy#58]
Functions: []
Aggregate Attributes: []
Results [6]: [gross_margin#55, i_category#10, i_class#9, t_category#56, t_class#57, lochierarchy#58]

(57) Exchange
Input [6]: [gross_margin#55, i_category#10, i_class#9, t_category#56, t_class#57, lochierarchy#58]
Arguments: hashpartitioning(gross_margin#55, i_category#10, i_class#9, t_category#56, t_class#57, lochierarchy#58, 5), ENSURE_REQUIREMENTS, [id=#186]

(58) HashAggregate [codegen id : 25]
Input [6]: [gross_margin#55, i_category#10, i_class#9, t_category#56, t_class#57, lochierarchy#58]
Keys [6]: [gross_margin#55, i_category#10, i_class#9, t_category#56, t_class#57, lochierarchy#58]
Functions: []
Aggregate Attributes: []
Results [5]: [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, CASE WHEN (t_class#57 = 0) THEN i_category#10 END AS _w0#187]

(59) Exchange
Input [5]: [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, _w0#187]
Arguments: hashpartitioning(lochierarchy#58, _w0#187, 5), ENSURE_REQUIREMENTS, [id=#188]

(60) Sort [codegen id : 26]
Input [5]: [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, _w0#187]
Arguments: [lochierarchy#58 ASC NULLS FIRST, _w0#187 ASC NULLS FIRST, gross_margin#55 ASC NULLS FIRST], false, 0

(61) Window
Input [5]: [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, _w0#187]
Arguments: [rank(gross_margin#55) windowspecdefinition(lochierarchy#58, _w0#187, gross_margin#55 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rank_within_parent#189], [lochierarchy#58, _w0#187], [gross_margin#55 ASC NULLS FIRST]

(62) Project [codegen id : 27]
Output [5]: [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, rank_within_parent#189]
Input [6]: [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, _w0#187, rank_within_parent#189]

(63) TakeOrderedAndProject
Input [5]: [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, rank_within_parent#189]
Arguments: 100, [lochierarchy#58 DESC NULLS LAST, CASE WHEN (lochierarchy#58 = 0) THEN i_category#10 END ASC NULLS FIRST, rank_within_parent#189 ASC NULLS FIRST], [gross_margin#55, i_category#10, i_class#9, lochierarchy#58, rank_within_parent#189]

===== Subqueries =====

Subquery:1 Hosting operator id = 1 Hosting Expression = ss_sold_date_sk#5 IN dynamicpruning#6
BroadcastExchange (68)
+- * Project (67)
   +- * Filter (66)
      +- * ColumnarToRow (65)
         +- Scan parquet default.date_dim (64)


(64) Scan parquet default.date_dim
Output [2]: [d_date_sk#7, d_year#83]
Batched: true
Location [not included in comparison]/{warehouse_dir}/date_dim]
PushedFilters: [IsNotNull(d_year), EqualTo(d_year,2001), IsNotNull(d_date_sk)]
ReadSchema: struct<d_date_sk:int,d_year:int>

(65) ColumnarToRow [codegen id : 1]
Input [2]: [d_date_sk#7, d_year#83]

(66) Filter [codegen id : 1]
Input [2]: [d_date_sk#7, d_year#83]
Condition : ((isnotnull(d_year#83) AND (d_year#83 = 2001)) AND isnotnull(d_date_sk#7))

(67) Project [codegen id : 1]
Output [1]: [d_date_sk#7]
Input [2]: [d_date_sk#7, d_year#83]

(68) BroadcastExchange
Input [1]: [d_date_sk#7]
Arguments: HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint)),false), [id=#190]

Subquery:2 Hosting operator id = 26 Hosting Expression = ss_sold_date_sk#5 IN dynamicpruning#77
BroadcastExchange (72)
+- * Filter (71)
   +- * ColumnarToRow (70)
      +- Scan parquet default.date_dim (69)


(69) Scan parquet default.date_dim
Output [28]: [d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104]
Batched: true
Location [not included in comparison]/{warehouse_dir}/date_dim]
PushedFilters: [IsNotNull(d_year), EqualTo(d_year,2001), IsNotNull(d_date_sk)]
ReadSchema: struct<d_date_sk:int,d_date_id:string,d_date:date,d_month_seq:int,d_week_seq:int,d_quarter_seq:int,d_year:int,d_dow:int,d_moy:int,d_dom:int,d_qoy:int,d_fy_year:int,d_fy_quarter_seq:int,d_fy_week_seq:int,d_day_name:string,d_quarter_name:string,d_holiday:string,d_weekend:string,d_following_holiday:string,d_first_dom:int,d_last_dom:int,d_same_day_ly:int,d_same_day_lq:int,d_current_day:string,d_current_week:string,d_current_month:string,d_current_quarter:string,d_current_year:string>

(70) ColumnarToRow [codegen id : 1]
Input [28]: [d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104]

(71) Filter [codegen id : 1]
Input [28]: [d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104]
Condition : ((isnotnull(d_year#83) AND (d_year#83 = 2001)) AND isnotnull(d_date_sk#7))

(72) BroadcastExchange
Input [28]: [d_date_sk#7, d_date_id#78, d_date#79, d_month_seq#80, d_week_seq#81, d_quarter_seq#82, d_year#83, d_dow#84, d_moy#85, d_dom#86, d_qoy#87, d_fy_year#88, d_fy_quarter_seq#89, d_fy_week_seq#90, d_day_name#91, d_quarter_name#92, d_holiday#93, d_weekend#94, d_following_holiday#95, d_first_dom#96, d_last_dom#97, d_same_day_ly#98, d_same_day_lq#99, d_current_day#100, d_current_week#101, d_current_month#102, d_current_quarter#103, d_current_year#104]
Arguments: HashedRelationBroadcastMode(List(cast(input[0, int, false] as bigint)),false), [id=#191]


